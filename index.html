<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InnovA+ Login</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="document-styles.css">
  <link rel="stylesheet" href="vr-styles.css">
  <script src="api-config.js"></script>
  <script src="gemini-api.js"></script>
</head>
<body>
  <div id="login-container" class="login-container">
    <div class="login-box">
      <img src="logo.svg" alt="Logo" class="login-logo">
      <h1>InnovA+</h1>
      <form id="login-form" class="login-form" novalidate>
        <div class="input-group">
          <input type="email" id="email" placeholder="Correo electr√≥nico" required autocomplete="email">
          <div class="input-validation-message" id="email-error"></div>
        </div>
        <div class="input-group">
          <input type="password" id="password" placeholder="Contrase√±a o c√≥digo de 4 d√≠gitos" required autocomplete="current-password">
          <div class="input-validation-message" id="password-error"></div>
        </div>
        <button type="submit" class="login-btn" id="login-btn">Iniciar Sesi√≥n</button>
        <!-- Quick access button will be added here by JavaScript -->
      </form>
      <p class="forgot-password">
        <a href="#" id="forgot-password-link">¬øOlvidaste tu contrase√±a?</a>
      </p>
      <p class="signup-text">¬øNo tienes cuenta? <a href="#" id="show-signup">Reg√≠strate</a></p>
    </div>
  </div>

  <div id="signup-container" class="login-container hidden">
    <div class="login-box">
      <img src="logo.svg" alt="Logo" class="login-logo">
      <h1>Registro</h1>
      <form id="signup-form" class="login-form" novalidate>
        <div class="input-group">
          <input type="text" id="username" placeholder="Nombre de usuario" required autocomplete="username">
          <div class="input-validation-message" id="username-error"></div>
        </div>
        <div class="input-group">
          <input type="email" id="signup-email" placeholder="Correo electr√≥nico" required autocomplete="email">
          <div class="input-validation-message" id="signup-email-error"></div>
        </div>
        <div class="input-group">
          <input type="password" id="signup-password" placeholder="Contrase√±a (m√≠n. 8 caracteres)" required autocomplete="new-password">
          <div class="password-strength" id="password-strength">
            <div class="password-strength-bar"></div>
          </div>
          <div class="input-validation-message" id="signup-password-error"></div>
        </div>
        <button type="submit" class="login-btn" id="signup-btn">Registrarse</button>
      </form>
      <p class="signup-text">¬øYa tienes cuenta? <a href="#" id="show-login">Inicia sesi√≥n</a></p>
    </div>
  </div>

  <!-- Password Recovery Modal -->
  <div id="password-recovery-modal" class="auth-modal hidden">
    <div class="auth-modal-content">
      <div class="auth-modal-header">
        <h2>Recuperar Contrase√±a</h2>
        <button class="auth-modal-close" id="close-recovery-modal">&times;</button>
      </div>
      <div class="auth-modal-body">
        <div id="recovery-step-1" class="recovery-step">
          <p>Ingresa tu correo electr√≥nico y te enviaremos un enlace para recuperar tu contrase√±a.</p>
          <form id="recovery-form" class="auth-form">
            <div class="input-group">
              <input type="email" id="recovery-email" placeholder="Correo electr√≥nico" required>
              <div class="input-validation-message" id="recovery-email-error"></div>
            </div>
            <button type="submit" class="auth-btn" id="send-recovery-btn">
              <svg class="auth-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
              Enviar Enlace de Recuperaci√≥n
            </button>
          </form>
        </div>

        <div id="recovery-step-2" class="recovery-step hidden">
          <div class="recovery-success">
            <svg class="success-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S7.52 2 12 2zm-2 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            <h3>¬°Enlace Enviado!</h3>
            <p>Hemos enviado un enlace de recuperaci√≥n a tu correo electr√≥nico.</p>
            <p class="recovery-token-info">
              <strong>Para esta demostraci√≥n, usa este token:</strong>
              <code id="demo-token" class="demo-token"></code>
              <button class="copy-token-btn" onclick="copyToken()">üìã Copiar</button>
            </p>
            <p class="token-expiry">El token expira en 15 minutos</p>
            <button class="auth-btn secondary" id="use-token-btn">Usar Token</button>
          </div>
        </div>

        <div id="recovery-step-3" class="recovery-step hidden">
          <h3>Restablecer Contrase√±a</h3>
          <form id="reset-password-form" class="auth-form">
            <div class="input-group">
              <input type="text" id="reset-token" placeholder="Token de recuperaci√≥n" required>
              <div class="input-validation-message" id="reset-token-error"></div>
            </div>
            <div class="input-group">
              <input type="password" id="new-password" placeholder="Nueva contrase√±a (m√≠n. 6 caracteres)" required>
              <div class="password-strength" id="new-password-strength">
                <div class="password-strength-bar"></div>
              </div>
              <div class="input-validation-message" id="new-password-error"></div>
            </div>
            <div class="input-group">
              <input type="password" id="confirm-password" placeholder="Confirmar nueva contrase√±a" required>
              <div class="input-validation-message" id="confirm-password-error"></div>
            </div>
            <button type="submit" class="auth-btn" id="reset-password-btn">
              <svg class="auth-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
              Restablecer Contrase√±a
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="change-password-modal" class="auth-modal hidden">
    <div class="auth-modal-content">
      <div class="auth-modal-header">
        <h2>Cambiar Contrase√±a</h2>
        <button class="auth-modal-close" id="close-change-password-modal">&times;</button>
      </div>
      <div class="auth-modal-body">
        <form id="change-password-form" class="auth-form">
          <div class="input-group">
            <input type="password" id="current-password" placeholder="Contrase√±a actual" required>
            <div class="input-validation-message" id="current-password-error"></div>
          </div>
          <div class="input-group">
            <input type="password" id="change-new-password" placeholder="Nueva contrase√±a (m√≠n. 6 caracteres)" required>
            <div class="password-strength" id="change-password-strength">
              <div class="password-strength-bar"></div>
            </div>
            <div class="input-validation-message" id="change-new-password-error"></div>
          </div>
          <div class="input-group">
            <input type="password" id="change-confirm-password" placeholder="Confirmar nueva contrase√±a" required>
            <div class="input-validation-message" id="change-confirm-password-error"></div>
          </div>
          <button type="submit" class="auth-btn" id="change-password-btn">
            <svg class="auth-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            Cambiar Contrase√±a
          </button>
        </form>
      </div>
    </div>
  </div>

  <div id="chat-app" class="hidden">
    <div class="chat-container">
      <div class="chat-header">
        <img src="logo.svg" alt="Logo" class="logo">
        <h1>InnovA+</h1>
        <div class="model-info">
          <span class="model-badge">InnovA+ 1T</span>
        </div>
      </div>

      <div id="chat-messages" class="chat-messages"></div>

      <div class="chat-input-container">
        <div class="mode-selector">
          <label class="mode-toggle">
            <input type="checkbox" id="mode-analytical" checked>
            <span class="mode-label">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
              </svg>
              An√°lisis Profundo
            </span>
          </label>
          <label class="mode-toggle">
            <input type="checkbox" id="mode-research" checked>
            <span class="mode-label">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S5 5.91 5 9.5 7.01 16 7.01 16c1.61 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
              Investigaci√≥n Web
            </span>
          </label>
          <label class="mode-toggle">
            <input type="checkbox" id="mode-image" checked>
            <span class="mode-label">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1.9-2 2-2zm-1.6 14.2h-6.8v-1.5h6.8v1.5zm0-3.5h-6.8V8.7h6.8v1.5zM7.5 18h-2v-2h2v2zm0-3.5h-2v-2h2v2zm0-3.5h-2V9h2v2z"/>
              </svg>
              Generaci√≥n de Im√°genes
            </span>
          </label>
          <label class="mode-toggle">
            <input type="checkbox" id="mode-document" checked>
            <span class="mode-label">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
              Generaci√≥n de Documentos
            </span>
          </label>
          <label class="mode-toggle">
            <input type="checkbox" id="mode-vr" checked>
            <span class="mode-label">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.8 18.4L14 10.67V6.5l1.35-1.69c.26-.33.03-.81-.39-.81H9.04c-.42 0-.65.48-.39.81L10 6.5v4.17L19 8l-9 9z"/>
              </svg>
              Realidad Virtual
            </span>
          </label>
          <label class="mode-toggle">
            <input type="checkbox" id="mode-code" checked>
            <span class="mode-label">
              <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L19 8l-9 9z"/>
              </svg>
              Generaci√≥n de C√≥digo
            </span>
          </label>
        </div>

        <div class="input-row">
          <textarea id="user-input" placeholder="Escribe tu mensaje..." rows="2"></textarea>
          <button id="send-btn">
            <svg class="send-icon" viewBox="0 0 24 24">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="user-menu-item change-password">
      <svg class="menu-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
      </svg>
      Cambiar Contrase√±a
    </div>

    <!-- Image Generation Modal -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <button id="closeModal" class="modal-close">&times;</button>
        <img id="modalImage" src="" alt="Generated image">
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/docxtemplater@3.42.4/build/docxtemplater.js"></script>
  <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="documents.js"></script>
  <script src="script.js"></script>
  <script src="auth-handlers.js"></script>
  <script src="auth.js"></script>
  <script src="virtual-reality.js"></script>
  <link rel="stylesheet" href="code-styles.css">
  <script src="code-generator.js"></script>

  <script>
    // Global function to copy token
    function copyToken() {
      const tokenElement = document.getElementById('demo-token');
      const token = tokenElement.textContent;
      
      navigator.clipboard.writeText(token).then(() => {
        const copyBtn = document.querySelector('.copy-token-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úì Copiado!';
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      });
    }

    // Enhanced form validation and interaction
    document.addEventListener('DOMContentLoaded', function() {
      const forms = document.querySelectorAll('form');
      
      forms.forEach(form => {
        const inputs = form.querySelectorAll('input');
        
        inputs.forEach(input => {
          input.addEventListener('input', function() {
            validateInput(this);
          });
          
          input.addEventListener('blur', function() {
            validateInput(this);
          });
        });
      });

      // Password strength checker
      const signupPassword = document.getElementById('signup-password');
      if (signupPassword) {
        signupPassword.addEventListener('input', function() {
          checkPasswordStrength(this.value);
        });
      }

      function validateInput(input) {
        const inputGroup = input.parentElement;
        const errorElement = inputGroup.querySelector('.input-validation-message');
        let isValid = true;
        let message = '';

        // Clear previous states
        inputGroup.classList.remove('error', 'success');
        errorElement.classList.remove('show');

        switch(input.type) {
          case 'email':
            if (input.value && !isValidEmail(input.value)) {
              isValid = false;
              message = 'Por favor ingresa un email v√°lido';
            }
            break;
          
          case 'password':
            if (input.id === 'signup-password' && input.value) {
              if (input.value.length < 8) {
                isValid = false;
                message = 'La contrase√±a debe tener al menos 8 caracteres';
              } else if (!isStrongPassword(input.value)) {
                isValid = false;
                message = 'Debe incluir may√∫sculas, min√∫sculas, n√∫meros y s√≠mbolos';
              }
            }
            break;
          
          case 'text':
            if (input.id === 'username' && input.value) {
              if (input.value.length < 3) {
                isValid = false;
                message = 'M√≠nimo 3 caracteres';
              } else if (!/^[a-zA-Z0-9_]+$/.test(input.value)) {
                isValid = false;
                message = 'Solo letras, n√∫meros y guiones bajos';
              }
            }
            break;
        }

        if (!isValid) {
          inputGroup.classList.add('error');
          errorElement.textContent = message;
          errorElement.classList.add('show');
        } else if (input.value) {
          inputGroup.classList.add('success');
        }

        return isValid;
      }

      function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function isStrongPassword(password) {
        return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(password);
      }

      function checkPasswordStrength(password) {
        const strengthElement = document.getElementById('password-strength');
        if (!strengthElement) return;

        let strength = 0;
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[@$!%*?&]/.test(password)) strength++;

        strengthElement.className = 'password-strength';
        
        if (strength >= 5) {
          strengthElement.classList.add('strong');
        } else if (strength >= 4) {
          strengthElement.classList.add('good');
        } else if (strength >= 2) {
          strengthElement.classList.add('fair');
        } else if (strength >= 1) {
          strengthElement.classList.add('weak');
        }
      }

      // Enhanced form submission handling
      document.getElementById('login-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('login-btn');
        const originalText = btn.textContent;
        
        btn.disabled = true;
        btn.classList.add('login-loading');
        btn.textContent = 'Iniciando sesi√≥n...';
        
        setTimeout(() => {
          window.auth?.login().finally(() => {
            btn.disabled = false;
            btn.classList.remove('login-loading');
            btn.textContent = originalText;
          });
        }, 100);
      });

      document.getElementById('signup-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('signup-btn');
        const originalText = btn.textContent;
        
        btn.disabled = true;
        btn.classList.add('login-loading');
        btn.textContent = 'Registrando...';
        
        setTimeout(() => {
          window.auth?.signup().finally(() => {
            btn.disabled = false;
            btn.classList.remove('login-loading');
            btn.textContent = originalText;
          });
        }, 100);
      });

      // Password recovery functionality
      const forgotPasswordLink = document.getElementById('forgot-password-link');
      const recoveryModal = document.getElementById('password-recovery-modal');
      const closeRecoveryModal = document.getElementById('close-recovery-modal');
      const recoveryForm = document.getElementById('recovery-form');
      const resetPasswordForm = document.getElementById('reset-password-form');
      const useTokenBtn = document.getElementById('use-token-btn');

      // Change password functionality  
      const changePasswordModal = document.getElementById('change-password-modal');
      const closeChangePasswordModal = document.getElementById('close-change-password-modal');
      const changePasswordForm = document.getElementById('change-password-form');

      // Show password recovery modal
      if (forgotPasswordLink) {
        forgotPasswordLink.addEventListener('click', (e) => {
          e.preventDefault();
          recoveryModal.classList.remove('hidden');
          showRecoveryStep(1);
        });
      }

      // Close modals
      if (closeRecoveryModal) {
        closeRecoveryModal.addEventListener('click', () => {
          recoveryModal.classList.add('hidden');
        });
      }

      if (closeChangePasswordModal) {
        closeChangePasswordModal.addEventListener('click', () => {
          changePasswordModal.classList.add('hidden');
        });
      }

      // Close modals when clicking outside
      [recoveryModal, changePasswordModal].forEach(modal => {
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.add('hidden');
            }
          });
        }
      });

      // Recovery form submission
      if (recoveryForm) {
        recoveryForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('recovery-email').value;
          const btn = document.getElementById('send-recovery-btn');
          
          try {
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            
            const result = await AuthenticationHandlers.handlePasswordRecovery(email);
            
            // Show token for demo purposes
            document.getElementById('demo-token').textContent = result.token;
            showRecoveryStep(2);
            
          } catch (error) {
            document.getElementById('recovery-email-error').textContent = error.message;
            document.getElementById('recovery-email-error').classList.add('show');
          } finally {
            btn.disabled = false;
            btn.innerHTML = `
              <svg class="auth-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
              </svg>
              Enviar Enlace de Recuperaci√≥n
            `;
          }
        });
      }

      // Use token button
      if (useTokenBtn) {
        useTokenBtn.addEventListener('click', () => {
          const token = document.getElementById('demo-token').textContent;
          document.getElementById('reset-token').value = token;
          showRecoveryStep(3);
        });
      }

      // Reset password form submission
      if (resetPasswordForm) {
        resetPasswordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const token = document.getElementById('reset-token').value;
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;
          const btn = document.getElementById('reset-password-btn');

          // Clear previous errors
          document.querySelectorAll('#recovery-step-3 .input-validation-message').forEach(el => {
            el.classList.remove('show');
          });

          if (newPassword !== confirmPassword) {
            document.getElementById('confirm-password-error').textContent = 'Las contrase√±as no coinciden';
            document.getElementById('confirm-password-error').classList.add('show');
            return;
          }

          try {
            btn.disabled = true;
            btn.textContent = 'Restableciendo...';
            
            await AuthenticationHandlers.handlePasswordReset(token, newPassword);
            
            alert('¬°Contrase√±a restablecida exitosamente! Ahora puedes iniciar sesi√≥n con tu nueva contrase√±a.');
            recoveryModal.classList.add('hidden');
            
          } catch (error) {
            document.getElementById('reset-token-error').textContent = error.message;
            document.getElementById('reset-token-error').classList.add('show');
          } finally {
            btn.disabled = false;
            btn.innerHTML = `
              <svg class="auth-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
              Restablecer Contrase√±a
            `;
          }
        });
      }

      // Change password form submission
      if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const currentPassword = document.getElementById('current-password').value;
          const newPassword = document.getElementById('change-new-password').value;
          const confirmPassword = document.getElementById('change-confirm-password').value;
          const btn = document.getElementById('change-password-btn');

          // Clear previous errors
          document.querySelectorAll('#change-password-modal .input-validation-message').forEach(el => {
            el.classList.remove('show');
          });

          if (newPassword !== confirmPassword) {
            document.getElementById('change-confirm-password-error').textContent = 'Las contrase√±as no coinciden';
            document.getElementById('change-confirm-password-error').classList.add('show');
            return;
          }

          try {
            btn.disabled = true;
            btn.textContent = 'Cambiando...';
            
            const currentUser = JSON.parse(localStorage.getItem('user'));
            await AuthenticationHandlers.handlePasswordChange(currentUser.id, currentPassword, newPassword);
            
            alert('¬°Contrase√±a cambiada exitosamente!');
            changePasswordModal.classList.add('hidden');
            changePasswordForm.reset();
            
          } catch (error) {
            if (error.message.includes('actual es incorrecta')) {
              document.getElementById('current-password-error').textContent = error.message;
              document.getElementById('current-password-error').classList.add('show');
            } else {
              document.getElementById('change-new-password-error').textContent = error.message;
              document.getElementById('change-new-password-error').classList.add('show');
            }
          } finally {
            btn.disabled = false;
            btn.innerHTML = `
              <svg class="auth-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
              </svg>
              Cambiar Contrase√±a
            `;
          }
        });
      }

      function showRecoveryStep(step) {
        document.querySelectorAll('.recovery-step').forEach(el => el.classList.add('hidden'));
        document.getElementById(`recovery-step-${step}`).classList.remove('hidden');
      }

      // ...existing code...
    });
  </script>
</body>
</html>